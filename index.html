<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>player-shuffle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
          crossorigin="anonymous">
</head>
<body>
<div class="container pt-2">
    <div class="row">
        <div class="col d-flex justify-content-end">
            <button class="btn btn-primary rounded-0" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
                Settings
            </button>
        </div>
    </div>
    <br/>
    <div class="row">
        <div class="col">
            <div class="fs-1 text-center">Playing</div>
            <ul id="games" class="list-group rounded-0"></ul>
        </div>
    </div>
    <br/>
    <div class="row">
        <div class="col">
            <div class="fs-1 text-center">Resting</div>
            <ul id="bench-warmers" class="list-group rounded-0"></ul>
        </div>
    </div>
    <div class="row fixed-bottom">
        <div class="col d-grid">
            <button id="generate-pairs" class="btn btn-primary btn-lg rounded-0">Shuffle</button>
        </div>
    </div>
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasExampleLabel">Settings</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="row mb-3">
                <div class="col">
                    <label for="court-input">
                        <b>Courts</b>
                    </label>
                    <input id="court-input" class="form-control mt-2 rounded-0" type="number" min="1" max="5" value="1">
                </div>
            </div>
            <div class="row">
                <div class="col ">
                    <b>Players</b>
                    <div id="players"></div>
                    <br/>
                    <button id="add-player" class="btn btn-primary rounded-0">Add Player</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
        integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8="
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"
        integrity="sha256-qXBd/EfAdjOA2FGrGAG+b3YBn2tn5A6bhz+LSgYD96k="
        crossorigin="anonymous"></script>
<script>
    const SCOPE = {};
    (() => {
        'use strict';
        SCOPE.getCourts = () => {
            return parseInt(JSON.parse(window.localStorage.getItem('courts') || "1"));
        }
        SCOPE.setCourts = (courts) => {
            window.localStorage.setItem('courts', JSON.stringify(courts));
        }

        SCOPE.getPlayers = () => {
            return JSON.parse(window.localStorage.getItem('players') || "[]");
        };
        SCOPE.addPlayer = (name) => {
            const players = SCOPE.getPlayers();
            players.push({
                name: name, id: players.length === 0 ? 1 : players.map(p => p.id).reduce(function (p, v) {
                    return (p > v ? p : v);
                }) + 1
            });
            window.localStorage.setItem('players', JSON.stringify(players));
        };
        SCOPE.removePlayer = (id) => {
            const players = SCOPE.getPlayers();
            window.localStorage.setItem('players', JSON.stringify(players.filter(p => parseInt(p.id) !== parseInt(id))));
        };
        SCOPE.updatePlayer = (id, name) => {
            const players = SCOPE.getPlayers();
            for (let i in players) {
                const p = players[i];
                if (parseInt(p.id) === parseInt(id)) {
                    p.name = name;
                }
            }
            window.localStorage.setItem('players', JSON.stringify(players));
        }
        SCOPE.generatePairs = () => {
            const shuffledPlayers = _.shuffle(SCOPE.getPlayers());
            let benchWarmers = [];
            if (shuffledPlayers.length % 2 !== 0) {
                benchWarmers.push(shuffledPlayers.pop());
            }
            const pairedPlayers = _.chunk(shuffledPlayers, 2);
            if (pairedPlayers.length % 2 !== 0) {
                pairedPlayers.pop().forEach(player => {
                    benchWarmers.push(player);
                })
            }
            const games = _.chunk(pairedPlayers, 2);
            const courtsLimit = SCOPE.getCourts();
            if (courtsLimit < games.length) {
                const discardedDueToCourtLimit = games.splice(0, games.length - courtsLimit);
                discardedDueToCourtLimit
                    .forEach(g => g
                        .forEach(pair => pair
                            .forEach(player => benchWarmers.push(player))));
            }
            const res = {
                shuffledPlayers,
                pairedPlayers,
                benchWarmers,
                games
            };
            window.localStorage.setItem('generatedPairs', JSON.stringify(res));
            return res;
        }
        SCOPE.getGeneratedPairs = () => {
            return JSON.parse(window.localStorage.getItem('generatedPairs') || "{benchWarmers: [], playingPlayers: []}");
        }
        $(() => {
            const createPlayerInput = ({id, name}) => {
                return `<div class="d-flex mt-2">
                        <input id="${id}" type="text" class="player-input form-control rounded-0" value="${name}"/>&nbsp;
                        <button id="${id}" class="remove-player btn btn-danger rounded-0" style="background:red; color:white">X</button>
                    </div>
`;
            }
            const gameView = (game) => {
                return `<li class="list-group-item d-flex justify-content-between">
                            <div style="width: 30%;">
                                <p class="fs-1 text-center">
                                    <span>${game[0][0].name}</span> <br/>
                                    <span>${game[0][1].name}</span>
                                </p>
                            </div>
                            <div class="align-self-center text-center flex-grow-1">
                                <h5>VS</h5>
                            </div>
                            <div style="width: 30%;">
                                <p class="fs-1 text-center">
                                    <span>${game[1][0].name}</span> <br/>
                                    <span>${game[1][1].name}</span>
                                </p>
                            </div>
                        </li>`;
            }
            const benchView = ({name}) => {
                return `<li class="list-group-item fs-1">${name}</li>`;
            }
            $(document).on('click', '.remove-player', (e) => {
                const id = this.event.target.id;
                SCOPE.removePlayer(id);
                render();
            });
            $(document).on('click', '#add-player', (e) => {
                SCOPE.addPlayer('no_name');
                render();
            });
            $(document).on('click', '#generate-pairs', (e) => {
                render();
            });
            $(document).on('change', '.player-input', (e) => {
                const id = this.event.target.id;
                const value = this.event.target.value;
                SCOPE.updatePlayer(id, value);
                render();
            });
            $(document).on('change', '#court-input', (e) => {
                const value = this.event.target.value;
                SCOPE.setCourts(value);
                render();
            });
            const render = () => {
                const selector = $("#players");
                selector.empty();
                SCOPE.getPlayers().forEach(p => selector.append(createPlayerInput(p)));
                $("#court-input").val(SCOPE.getCourts());
                SCOPE.generatePairs();
                const gamesSelector = $("#games");
                gamesSelector.empty();
                SCOPE.getGeneratedPairs().games
                    .forEach(pp => gamesSelector.append(gameView(pp)))
                const benchWarmSelector = $("#bench-warmers");
                benchWarmSelector.empty();
                SCOPE.getGeneratedPairs().benchWarmers
                    .forEach(pp => benchWarmSelector.append(benchView(pp)))
            };
            render();
        });
    })();
</script>
</body>
</html>